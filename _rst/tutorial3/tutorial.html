<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. Tutorial 3: resolution of wave equation with custom Network &mdash; PINA 0.0.3.post2311 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4. Tutorial 4: continuous convolutional filter" href="../tutorial4/tutorial.html" />
    <link rel="prev" title="2. Tutorial 2: resolution of Poisson problem and usage of extra-features" href="../tutorial2/tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PINA
          </a>
              <div class="version">
                0.0.3.post2311
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Package Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial1/tutorial.html">1. Getting start with PINA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial2/tutorial.html">2. Poisson problem</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Wave equation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-problem-solution">3.1. The problem solution</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial4/tutorial.html">4. Continuous Convolutional Filter</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PINA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">3. </span>Tutorial 3: resolution of wave equation with custom Network</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/_rst/tutorial3/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="tutorial-3-resolution-of-wave-equation-with-custom-network">
<h1><span class="section-number">3. </span>Tutorial 3: resolution of wave equation with custom Network<a class="headerlink" href="#tutorial-3-resolution-of-wave-equation-with-custom-network" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-problem-solution">
<h2><span class="section-number">3.1. </span>The problem solution<a class="headerlink" href="#the-problem-solution" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we present how to solve the wave equation using the
<code class="docutils literal notranslate"><span class="pre">SpatialProblem</span></code> and <code class="docutils literal notranslate"><span class="pre">TimeDependentProblem</span></code> class, and the
<code class="docutils literal notranslate"><span class="pre">Network</span></code> class for building custom <strong>torch</strong> networks.</p>
<p>The problem is written in the following form:</p>
<p><a href="#id1"><span class="problematic" id="id2">:raw-latex:`\begin{equation}
\begin{cases}
\Delta u(x,y,t) = \frac{\partial^2}{\partial t^2} u(x,y,t) \quad \text{in } D, \\\\
u(x, y, t=0) = \sin(\pi x)\sin(\pi y), \\\\
u(x, y, t) = 0 \quad \text{on } \Gamma_1 \cup \Gamma_2 \cup \Gamma_3 \cup \Gamma_4,
\end{cases}
\end{equation}`</span></a></p>
<p>where <span class="math notranslate nohighlight">\(D\)</span> is a square domain <span class="math notranslate nohighlight">\([0,1]^2\)</span>, and
<span class="math notranslate nohighlight">\(\Gamma_i\)</span>, with <span class="math notranslate nohighlight">\(i=1,...,4\)</span>, are the boundaries of the
square, and the velocity in the standard wave equation is fixed to one.</p>
<p>First of all, some useful imports.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import torch

from pina.problem import SpatialProblem, TimeDependentProblem
from pina.operators import nabla, grad
from pina.model import Network
from pina import Condition, Span, PINN, Plotter
</pre></div>
</div>
<p>Now, the wave problem is written in PINA code as a class, inheriting
from <code class="docutils literal notranslate"><span class="pre">SpatialProblem</span></code> and <code class="docutils literal notranslate"><span class="pre">TimeDependentProblem</span></code> since we deal with
spatial, and time dependent variables. The equations are written as
<code class="docutils literal notranslate"><span class="pre">conditions</span></code> that should be satisfied in the corresponding domains.
<code class="docutils literal notranslate"><span class="pre">truth_solution</span></code> is the exact solution which will be compared with the
predicted one.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class Wave(TimeDependentProblem, SpatialProblem):
    output_variables = [&#39;u&#39;]
    spatial_domain = Span({&#39;x&#39;: [0, 1], &#39;y&#39;: [0, 1]})
    temporal_domain = Span({&#39;t&#39;: [0, 1]})

    def wave_equation(input_, output_):
        u_t = grad(output_, input_, components=[&#39;u&#39;], d=[&#39;t&#39;])
        u_tt = grad(u_t, input_, components=[&#39;dudt&#39;], d=[&#39;t&#39;])
        nabla_u = nabla(output_, input_, components=[&#39;u&#39;], d=[&#39;x&#39;, &#39;y&#39;])
        return nabla_u - u_tt

    def nil_dirichlet(input_, output_):
        value = 0.0
        return output_.extract([&#39;u&#39;]) - value

    def initial_condition(input_, output_):
        u_expected = (torch.sin(torch.pi*input_.extract([&#39;x&#39;])) *
                      torch.sin(torch.pi*input_.extract([&#39;y&#39;])))
        return output_.extract([&#39;u&#39;]) - u_expected

    conditions = {
        &#39;gamma1&#39;: Condition(location=Span({&#39;x&#39;: [0, 1], &#39;y&#39;:  1, &#39;t&#39;: [0, 1]}), function=nil_dirichlet),
        &#39;gamma2&#39;: Condition(location=Span({&#39;x&#39;: [0, 1], &#39;y&#39;: 0, &#39;t&#39;: [0, 1]}), function=nil_dirichlet),
        &#39;gamma3&#39;: Condition(location=Span({&#39;x&#39;:  1, &#39;y&#39;: [0, 1], &#39;t&#39;: [0, 1]}), function=nil_dirichlet),
        &#39;gamma4&#39;: Condition(location=Span({&#39;x&#39;: 0, &#39;y&#39;: [0, 1], &#39;t&#39;: [0, 1]}), function=nil_dirichlet),
        &#39;t0&#39;: Condition(location=Span({&#39;x&#39;: [0, 1], &#39;y&#39;: [0, 1], &#39;t&#39;: 0}), function=initial_condition),
        &#39;D&#39;: Condition(location=Span({&#39;x&#39;: [0, 1], &#39;y&#39;: [0, 1], &#39;t&#39;: [0, 1]}), function=wave_equation),
    }

    def wave_sol(self, pts):
        return (torch.sin(torch.pi*pts.extract([&#39;x&#39;])) *
                torch.sin(torch.pi*pts.extract([&#39;y&#39;])) *
                torch.cos(torch.sqrt(torch.tensor(2.))*torch.pi*pts.extract([&#39;t&#39;])))

    truth_solution = wave_sol

problem = Wave()
</pre></div>
</div>
<p>After the problem, a <strong>torch</strong> model is needed to solve the PINN. With
the <code class="docutils literal notranslate"><span class="pre">Network</span></code> class the users can convert any <strong>torch</strong> model in a
<strong>PINA</strong> model which uses label tensors with a single line of code. We
will write a simple residual network using linear layers. Here we
implement a simple residual network composed by linear torch layers.</p>
<p>This neural network takes as input the coordinates (in this case
<span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(t\)</span>) and provides the unkwown field of
the Wave problem. The residual of the equations are evaluated at several
sampling points (which the user can manipulate using the method
<code class="docutils literal notranslate"><span class="pre">span_pts</span></code>) and the loss minimized by the neural network is the sum of
the residuals.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class TorchNet(torch.nn.Module):

    def __init__(self):
        super().__init__()

        self.residual = torch.nn.Sequential(torch.nn.Linear(3, 24),
                                            torch.nn.Tanh(),
                                            torch.nn.Linear(24, 3))

        self.mlp = torch.nn.Sequential(torch.nn.Linear(3, 64),
                                       torch.nn.Tanh(),
                                       torch.nn.Linear(64, 1))
    def forward(self, x):
        residual_x = self.residual(x)
        return self.mlp(x + residual_x)

# model definition
model = Network(model = TorchNet(),
                input_variables=problem.input_variables,
                output_variables=problem.output_variables,
                extra_features=None)
</pre></div>
</div>
<p>In this tutorial, the neural network is trained for 2000 epochs with a
learning rate of 0.001. These parameters can be modified as desired. We
highlight that the generation of the sampling points and the train is
here encapsulated within the function <code class="docutils literal notranslate"><span class="pre">generate_samples_and_train</span></code>,
but only for saving some lines of code in the next cells; that function
is not mandatory in the <strong>PINA</strong> framework. The training takes
approximately one minute.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def generate_samples_and_train(model, problem):
    # generate pinn object
    pinn = PINN(problem, model, lr=0.001)

    pinn.span_pts(1000, &#39;random&#39;, locations=[&#39;D&#39;,&#39;t0&#39;, &#39;gamma1&#39;, &#39;gamma2&#39;, &#39;gamma3&#39;, &#39;gamma4&#39;])
    pinn.train(1500, 150)
    return pinn


pinn = generate_samples_and_train(model, problem)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00000</span><span class="p">]</span> <span class="mf">1.021557e-01</span> <span class="mf">1.350026e-02</span> <span class="mf">4.368403e-03</span> <span class="mf">6.463497e-03</span> <span class="mf">1.698729e-03</span> <span class="mf">5.513944e-02</span> <span class="mf">2.098533e-02</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00001</span><span class="p">]</span> <span class="mf">8.096325e-02</span> <span class="mf">7.543423e-03</span> <span class="mf">2.978407e-03</span> <span class="mf">7.128799e-03</span> <span class="mf">2.084145e-03</span> <span class="mf">3.967418e-02</span> <span class="mf">2.155431e-02</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00150</span><span class="p">]</span> <span class="mf">4.684930e-02</span> <span class="mf">9.609548e-03</span> <span class="mf">3.093602e-03</span> <span class="mf">7.733506e-03</span> <span class="mf">2.570329e-03</span> <span class="mf">1.896760e-02</span> <span class="mf">4.874712e-03</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00300</span><span class="p">]</span> <span class="mf">3.519089e-02</span> <span class="mf">6.642059e-03</span> <span class="mf">2.865276e-03</span> <span class="mf">6.399740e-03</span> <span class="mf">2.900236e-03</span> <span class="mf">1.244203e-02</span> <span class="mf">3.941551e-03</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00450</span><span class="p">]</span> <span class="mf">2.766160e-02</span> <span class="mf">5.089254e-03</span> <span class="mf">2.789679e-03</span> <span class="mf">5.370538e-03</span> <span class="mf">3.071685e-03</span> <span class="mf">7.834940e-03</span> <span class="mf">3.505504e-03</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00600</span><span class="p">]</span> <span class="mf">2.361075e-02</span> <span class="mf">4.279066e-03</span> <span class="mf">2.785937e-03</span> <span class="mf">4.689044e-03</span> <span class="mf">3.101575e-03</span> <span class="mf">5.907214e-03</span> <span class="mf">2.847910e-03</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00750</span><span class="p">]</span> <span class="mf">8.005206e-02</span> <span class="mf">3.891625e-03</span> <span class="mf">2.690672e-03</span> <span class="mf">3.808867e-03</span> <span class="mf">3.402538e-03</span> <span class="mf">6.042966e-03</span> <span class="mf">6.021538e-02</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">00900</span><span class="p">]</span> <span class="mf">1.892301e-02</span> <span class="mf">3.592897e-03</span> <span class="mf">2.639081e-03</span> <span class="mf">3.797543e-03</span> <span class="mf">2.988781e-03</span> <span class="mf">3.860098e-03</span> <span class="mf">2.044612e-03</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">01050</span><span class="p">]</span> <span class="mf">1.739456e-02</span> <span class="mf">3.420912e-03</span> <span class="mf">2.557583e-03</span> <span class="mf">3.532733e-03</span> <span class="mf">2.910482e-03</span> <span class="mf">3.114843e-03</span> <span class="mf">1.858010e-03</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">01200</span><span class="p">]</span> <span class="mf">1.663617e-02</span> <span class="mf">3.213567e-03</span> <span class="mf">2.571464e-03</span> <span class="mf">3.355495e-03</span> <span class="mf">2.749454e-03</span> <span class="mf">3.247283e-03</span> <span class="mf">1.498912e-03</span>
              <span class="nb">sum</span>          <span class="n">gamma1nil_di</span> <span class="n">gamma2nil_di</span> <span class="n">gamma3nil_di</span> <span class="n">gamma4nil_di</span> <span class="n">t0initial_co</span> <span class="n">Dwave_equati</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">01350</span><span class="p">]</span> <span class="mf">1.551488e-02</span> <span class="mf">3.121611e-03</span> <span class="mf">2.481438e-03</span> <span class="mf">3.141828e-03</span> <span class="mf">2.706321e-03</span> <span class="mf">2.636140e-03</span> <span class="mf">1.427544e-03</span>
<span class="p">[</span><span class="n">epoch</span> <span class="mi">01500</span><span class="p">]</span> <span class="mf">1.497287e-02</span> <span class="mf">2.974171e-03</span> <span class="mf">2.475442e-03</span> <span class="mf">2.979754e-03</span> <span class="mf">2.593079e-03</span> <span class="mf">2.723322e-03</span> <span class="mf">1.227099e-03</span>
</pre></div>
</div>
<p>After the training is completed one can now plot some results using the
<code class="docutils literal notranslate"><span class="pre">Plotter</span></code> class of <strong>PINA</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plotter = Plotter()

# plotting at fixed time t = 0.6
plotter.plot(pinn, fixed_variables={&#39;t&#39;: 0.6})
</pre></div>
</div>
<img alt="../../_images/tutorial_12_0.png" src="../../_images/tutorial_12_0.png" />
<p>We can also plot the pinn loss during the training to see the decrease.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import matplotlib.pyplot as plt

plt.figure(figsize=(16, 6))
plotter.plot_loss(pinn, label=&#39;Loss&#39;)

plt.grid()
plt.legend()
plt.show()
</pre></div>
</div>
<img alt="../../_images/tutorial_14_0.png" src="../../_images/tutorial_14_0.png" />
<p>You can now trying improving the training by changing network, optimizer
and its parameters, changin the sampling points,or adding extra
features!</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../tutorial2/tutorial.html" class="btn btn-neutral float-left" title="2. Tutorial 2: resolution of Poisson problem and usage of extra-features" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../tutorial4/tutorial.html" class="btn btn-neutral float-right" title="4. Tutorial 4: continuous convolutional filter" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright 2021-2021, PINA contributors.
      <span class="lastupdated">Last updated on Nov 01, 2023.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>